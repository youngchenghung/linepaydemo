<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³¼ç‰©è»Šçµå¸³</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .cart-item { border: 1px solid #ddd; padding: 10px; margin: 10px; }
        .cart { margin-top: 20px; border-top: 2px solid black; padding-top: 10px; }
        .checkout-btn { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
    </style>
</head>
<body>

    <h1>ğŸ›’ è³¼ç‰©è»Šçµå¸³</h1>
    <div id="cart-list"></div>
    
    <button class="checkout-btn" onclick="checkout()">å‰å¾€ä»˜æ¬¾</button>
    <button onclick="clearCart()">æ¸…ç©ºè³¼ç‰©è»Š</button>

    <script>
        $(document).ready(function () {
            loadCart();
        });

        // å–å¾—è³¼ç‰©è»Šå…§å®¹ï¼Œä¸¦å°‡ç›¸åŒå•†å“æ•¸é‡ç´¯åŠ 
        function loadCart() {
            $.get("/shop/cart/items", function (data) {
                let cartList = $("#cart-list");
                cartList.empty();

                if (data.length === 0) {
                    cartList.append("<p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>");
                } else {
                    let cartMap = {}; // ç”¨æ–¼å„²å­˜åˆä½µçš„å•†å“æ•¸é‡
                    
                    // ç´¯åŠ ç›¸åŒå•†å“çš„æ•¸é‡
                    data.forEach(item => {
                        if (cartMap[item.id]) {
                            cartMap[item.id].quantity += item.quantity;
                        } else {
                            cartMap[item.id] = { name: item.name, quantity: item.quantity };
                        }
                    });

                    // é¡¯ç¤ºåˆä½µå¾Œçš„è³¼ç‰©è»Šå…§å®¹
                    Object.values(cartMap).forEach(item => {
                        cartList.append(`
                            <div class="cart-item">
                                <p>å•†å“ï¼š${item.name} - æ•¸é‡ï¼š${item.quantity}</p>
                            </div>
                        `);
                    });
                }
            });
        }

        // æ¸…ç©ºè³¼ç‰©è»Š
        function clearCart() {
            $.post("/shop/cart/clear", function () {
                alert("è³¼ç‰©è»Šå·²æ¸…ç©º");
                loadCart();
            });
        }

        // å–å¾—ä»˜æ¬¾é€£çµä¸¦è½‰è·³åˆ° LINE Pay
        function checkout() {
            $.post("/linepay/request", function (data) {
                if (data.info && data.info.paymentUrl && data.info.paymentUrl.web) {
                    let paymentUrl = data.info.paymentUrl.web;
                    let transactionId = data.info.transactionId;
                    
                    // ä»˜æ¬¾å®Œæˆå¾Œï¼ŒLINE Pay æœƒè¿”å› `transactionId`
                    let confirmUrl = window.location.origin + "/checkout.html?transactionId=" + transactionId;

                    // è½‰è·³åˆ° LINE Pay ä»˜æ¬¾é é¢
                    window.location.href = paymentUrl + "&redirectUrl=" + encodeURIComponent(confirmUrl);
                } else {
                    alert("ä»˜æ¬¾è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                }
            }).fail(function () {
                alert("ä»˜æ¬¾è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            });
        }

        // ä»˜æ¬¾å®Œæˆå¾Œï¼Œæª¢æŸ¥ URL æ˜¯å¦å¸¶æœ‰ `transactionId`
        function checkPaymentStatus() {
            let params = new URLSearchParams(window.location.search);
            let transactionId = params.get("transactionId");

            if (transactionId) {
                // å‘¼å«å¾Œç«¯ API é€²è¡Œä»˜æ¬¾ç¢ºèª
                $.post("/linepay/handleRedirect", { transactionId: transactionId }, function (response) {
                    if (response.success) {
                        alert("ä»˜æ¬¾æˆåŠŸï¼");
                        window.location.href = "/orderSuccess.html"; // ä»˜æ¬¾æˆåŠŸå¾Œè½‰è·³åˆ°è¨‚å–®æˆåŠŸé é¢
                    } else {
                        alert("ä»˜æ¬¾ç¢ºèªå¤±æ•—ï¼Œè«‹è¯ç¹«å®¢æœ");
                    }
                }).fail(function () {
                    alert("ä»˜æ¬¾ç¢ºèªè«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                });
            }
        }
    </script>

</body>
</html>
