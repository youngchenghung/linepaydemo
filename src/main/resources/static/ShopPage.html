<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šè³¼ç‰©</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .product, .cart-item { border: 1px solid #ddd; padding: 10px; margin: 10px; display: inline-block; }
        .cart { margin-top: 20px; border-top: 2px solid black; padding-top: 10px; }
    </style>
</head>
<body>

    <h1>å•†å“åˆ—è¡¨</h1>
    <div id="product-list"></div>

    <h2>ğŸ›’ è³¼ç‰©è»Š</h2>
    <div id="cart-list"></div>
    <button onclick="clearCart()">æ¸…ç©ºè³¼ç‰©è»Š</button>
    <button class="checkout-btn" onclick="goToCheckout()">å‰å¾€ä»˜æ¬¾</button>

    <script>
        $(document).ready(function () {
            loadProducts();
            loadCart();
        });

        // å–å¾—å•†å“æ¸…å–®
        function loadProducts() {
            $.get("/shop/products", function (data) {
                let productList = $("#product-list");
                productList.empty();
                data.forEach(product => {
                    productList.append(`
                        <div class="product">
                            <h3>${product.name}</h3>
                            <p>åƒ¹æ ¼ï¼š$${product.price}</p>
                            <button onclick="addToCart('${product.id}', '${product.name}', ${product.price})">åŠ å…¥è³¼ç‰©è»Š</button>
                        </div>
                    `);
                });
            });
        }

        // åŠ å…¥è³¼ç‰©è»Š
        function addToCart(id, name, price) {
            let cartItem = [{ id: id, name: name, imageUrl: "", price: price, quantity: 1 }];
            $.ajax({
                url: "/shop/cart/add",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(cartItem),
                success: function () {
                    alert(`${name} å·²åŠ å…¥è³¼ç‰©è»Š`);
                    loadCart();
                }
            });
        }

        // å–å¾—è³¼ç‰©è»Šå…§å®¹ï¼Œä¸¦ç´¯åŠ ç›¸åŒå•†å“çš„æ•¸é‡
        function loadCart() {
            $.get("/shop/cart/items", function (data) {
                let cartList = $("#cart-list");
                cartList.empty();
                
                if (data.length === 0) {
                    cartList.append("<p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>");
                    return;
                }
                
                let cartMap = {};
                
                // ç´¯åŠ ç›¸åŒå•†å“çš„æ•¸é‡
                data.forEach(item => {
                    if (cartMap[item.id]) {
                        cartMap[item.id].quantity += item.quantity;
                    } else {
                        cartMap[item.id] = { ...item };
                    }
                });
                
                // æ¸²æŸ“è³¼ç‰©è»Šå…§å®¹
                Object.values(cartMap).forEach(item => {
                    cartList.append(`
                        <div class="cart-item">
                            <p>å•†å“ï¼š${item.name} - æ•¸é‡ï¼š${item.quantity}</p>
                        </div>
                    `);
                });
            });
        }

        // æ¸…ç©ºè³¼ç‰©è»Š
        function clearCart() {
            $.post("/shop/cart/clear", function () {
                alert("è³¼ç‰©è»Šå·²æ¸…ç©º");
                loadCart();
            });
        }

        // å‰å¾€ä»˜æ¬¾é é¢
        function goToCheckout() {
            window.location.href = "LinePayPage.html";
        }
    </script>

</body>
</html>
