<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>購物頁面</title>
    <script>
        let cart = [];
        
        async function getProducts() {
            const response = await fetch('/products');
            const products = await response.json();
            renderProducts(products);
        }
        
        function renderProducts(products) {
            const productList = document.getElementById('product-list');
            productList.innerHTML = '';
            products.forEach(product => {
                const productItem = document.createElement('div');
                productItem.innerHTML = `
                    <p>${product.name} - $${product.price}</p>
                    <button onclick="addToCart(${product.id}, '${product.name}', ${product.price})">新增到購物車</button>
                `;
                productList.appendChild(productItem);
            });
        }
        
        function addToCart(id, name, price) {
            cart.push({ id, name, price });
            renderCart();
        }
        
        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }
        
        function renderCart() {
            const cartList = document.getElementById('cart-list');
            cartList.innerHTML = '';
            cart.forEach((item, index) => {
                const cartItem = document.createElement('div');
                cartItem.innerHTML = `
                    <p>${item.name} - $${item.price}</p>
                    <button onclick="removeFromCart(${index})">刪除</button>
                `;
                cartList.appendChild(cartItem);
            });
        }
        
        async function requestPayment() {
            if (cart.length === 0) {
                alert('購物車是空的！');
                return;
            }
            const response = await fetch('/cart/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: cart })
            });
            const data = await response.json();
            if (data.paymentUrl) {
                window.location.href = data.paymentUrl;
            } else {
                alert('付款請求失敗');
            }
        }
        
        window.onload = getProducts;
    </script>
</head>
<body>
    <h1>購物頁面</h1>
    <h2>商品列表</h2>
    <div id="product-list"></div>
    
    <h2>購物車</h2>
    <div id="cart-list"></div>
    <button onclick="requestPayment()">付款</button>
</body>
</html>
